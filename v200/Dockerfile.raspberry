# ğŸ³ Dockerfile Ø¨Ø±Ø§ÛŒ HomayOMS v200 - Raspberry Pi Production
# ğŸ—ï¸ Optimized for ARM architecture and production deployment

# ğŸ“¦ Stage 1: Base Python Image for ARM
FROM python:3.11-slim

# ğŸ·ï¸ Metadata
LABEL maintainer="Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¯Ø±Ø¨Ù†Ø¯ÛŒ <darbandidr99@gmail.com>"
LABEL description="HomayOMS v200 - Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª Ù‡ÙˆÙ…Ø§ (Raspberry Pi Production)"
LABEL version="v2.0-raspberry"

# ğŸ”§ ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    DJANGO_SETTINGS_MODULE=HomayOMS.settings.production \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ú©Ø§Ø±ÛŒ
WORKDIR /app

# ğŸ”§ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… (optimized for ARM)
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    postgresql-client \
    curl \
    gettext \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ğŸ“¦ Ú©Ù¾ÛŒ requirements.txt Ùˆ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ğŸ“ Ú©Ù¾ÛŒ Ú©Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡
COPY . .

# ğŸ¯ Entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# ğŸ‘¤ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± ØºÛŒØ± root Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª
RUN adduser --disabled-password --gecos '' django && \
    chown -R django:django /app

# ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
RUN mkdir -p /app/logs /app/staticfiles /app/media && \
    chown -R django:django /app/logs /app/staticfiles /app/media

# ğŸ”§ ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ ÙØ§ÛŒÙ„
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# ğŸ‘¤ ØªØºÛŒÛŒØ± Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± django
USER django

# ğŸŒ Expose Ù¾ÙˆØ±Øª
EXPOSE 8000

# ğŸš€ Health check (optimized for Raspberry Pi)
HEALTHCHECK --interval=60s --timeout=30s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/health/ || exit 1

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "2", "--timeout", "120", "--worker-class", "sync", "--max-requests", "1000", "--max-requests-jitter", "100", "HomayOMS.wsgi:application"] 